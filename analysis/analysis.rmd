---
title: "Simulator Validation (TCC)"
author: "David Ferreira Quaresma (david.quaresma@ccc.ufcg.edu.br)"
date: "april, 2021"
output: pdf_document
---

# LOAD DATA
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
result_path = "../results/"
require(dplyr)
read.al <- function(path) {
  df <- read.csv(path, sep=",",header=T, dec=".")
  return (df)
}
remove_warmup <- function(data, warmup_value=0) {
  if (warmup_value == 0) {
    return(data)
  } else {
    return(tail(data, -warmup_value))
  }
}

measurements = "NULL"
for (id in 1:4) {
  for (lambda in c(100, 200)) {
    path = paste(result_path, "measurements/measurement-lambda", lambda, "-", id, ".csv", sep="")
    measurement = remove_warmup(read.al(path))
    measurement$response_time = measurement$body / 1000000
    measurement = filter(measurement, response_time < 1000)
    measurement$id = paste("measurement-lambda", lambda, "-id", id, sep="")
    measurement$lambda = lambda
    if (measurements == "NULL") {
      measurements = measurement
    } else {
      measurements = rbind(measurements, measurement)
    }
  }
}
rm(measurement)

simulations = "NULL"
for (id in 1:4) {
  for (lambda in c(100, 200)) {
    path = paste(result_path, "simulation/sim-lambda", lambda, "-idleness300s-warmup0-id0", id, "-normscheduler-reqs.csv", sep="")
    simulation = remove_warmup(read.al(path))
    simulation$response_time = simulation$response_time * 1000
    simulation = filter(simulation, response_time < 1000)
    simulation$id = paste("simulation-lambda", lambda, "-id", id, sep="")
    simulation$lambda = lambda
    if (simulations == "NULL") {
      simulations = simulation
    } else {
      simulations = rbind(simulations, simulation)
    }
  }
}
rm(simulation)

inputs = rbind(
  remove_warmup(read.al(paste(result_path, "measurements/input1.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input2.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input3.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input4.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input5.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input6.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input7.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input8.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input9.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input10.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input11.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input12.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input13.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input14.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input15.csv", sep=""))),
  remove_warmup(read.al(paste(result_path, "measurements/input16.csv", sep="")))
  )
inputs$response_time = inputs$body / 1000000
inputs = filter(inputs, response_time < 1000)
```

# ECDF VISUAL TEST
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
ecdf_plot <- function(title, data, xinf, xsup, yinf, ysup, linetype=c("dashed", "solid", "dotted"), cols=c(15, 195, 150)) {
    data[, colSums(is.na(data)) != nrow(data)] %>%
    pivot_longer(everything()) %>%
    group_by(name) %>%
    arrange(value, by_group = TRUE) %>%
    mutate(ecdf = seq(1/n(), 1 - 1/n(), length.out = n())) %>%
    ggplot(aes(x = value, y = ecdf, colour=name, linetype=name)) +
    xlim(xinf, xsup) +
    ylim(yinf, ysup) +
    geom_step() +
    theme(text=element_text(size=12), plot.title = element_text(hjust = 0.5))+
    theme(legend.text=element_text(size=12)) +
    scale_fill_manual(values=hcl(cols, 100, 65, alpha=c(0.5, 1))) +
    scale_linetype_manual(values=linetype) +
    labs(x="Response Time (ms)",y="ECDF", color="scenario", linetype="scenario") +
    ggtitle(title)
}

ecdf_plot("VERIFYING RESULTS", data.frame(
  measurement = sample(filter(measurements, id == "measurement-lambda200-id1")$response_time, 15000),
  simulation  = sample(filter(simulations, id == "simulation-lambda200-id1")$response_time, 15000),
  inputs      = sample(inputs$response_time, 15000)
), 0, 1000, 0, 1)

ecdf_plot("VERIFYING SIMULATION", data.frame(
  simulations_lambda100 = sample(filter(simulations, lambda == 100)$response_time, 15000),
  simulations_lambda200  = sample(filter(simulations, lambda == 200)$response_time, 15000),
  inputs      = sample(inputs$response_time, 15000)
), 0, 1000, 0, 1)

ecdf_plot("VERIFYING MEASUREMENTS", data.frame(
  measurements_lambda100 = sample(filter(measurements, lambda == 100)$response_time, 15000),
  measurements_lambda200  = sample(filter(measurements, lambda == 200)$response_time, 15000),
  inputs      = sample(inputs$response_time, 15000)
), 0, 1000, 0, 1)

ecdf_plot("VERIFYING MEASUREMENTS FOR 100 LAMBDA", data.frame(
  measurements_lambda100_id1 = sample(filter(measurements, id == "measurement-lambda100-id1")$response_time, 15000),
  measurements_lambda100_id2  = sample(filter(measurements, id == "measurement-lambda100-id2")$response_time, 15000),
  measurements_lambda100_id3  = sample(filter(measurements, id == "measurement-lambda100-id3")$response_time, 15000)
), 0, 1000, 0, 1)

ecdf_plot("VERIFYING MEASUREMENTS FOR 200 LAMBDA", data.frame(
  measurements_lambda200_id1 = sample(filter(measurements, id == "measurement-lambda200-id1")$response_time, 15000),
  measurements_lambda200_id2  = sample(filter(measurements, id == "measurement-lambda200-id2")$response_time, 15000),
  measurements_lambda200_id3  = sample(filter(measurements, id == "measurement-lambda200-id3")$response_time, 15000)
), 0, 1000, 0, 1)
```

# BOXPLOT VISUAL TEST
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
boxplot_plot <- function(title, df_a, df_b, df_c, yrange, outliershape = NA) {
  return(ggplot(rbind(df_a, df_b, df_c), aes(x=scenario, y=response_time, fill=scenario)) +
  geom_boxplot(outlier.shape = outliershape) +
  scale_fill_manual(values=hcl(c(15, 195, 150), 100, 65, alpha=c(0.5, 1))) +
  coord_cartesian(ylim=yrange) + 
  theme(text=element_text(size=15)) +
  theme(legend.text=element_text(size=15)) +
  labs(x = "scenario", y = "indexing duration (ms)") +
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank(), axis.title.x = element_blank(), plot.title = element_text(hjust = 0.5)) +
  theme_bw() +
  ggtitle(title)
  )
}

measurement = filter(measurements, lambda == 200)
simulation = filter(simulations, lambda == 200)

df_sim_to_boxplot = data.frame(scenario = "sim", response_time = simulation$response_time)
df_mean_to_boxplot = data.frame(scenario = " mea", response_time = measurement$response_time)
df_imp_to_boxplot = data.frame(scenario = "imp", response_time = inputs$response_time)

boxplot_plot("NO Outliers", df_mean_to_boxplot, df_sim_to_boxplot, df_imp_to_boxplot, c(100, 300))
boxplot_plot("NO Cold Start", df_mean_to_boxplot, df_sim_to_boxplot, df_imp_to_boxplot, c(100, 1000), 16)

rm(df_sim_to_boxplot, df_mean_to_boxplot, df_imp_to_boxplot)
rm(measurement, simulation)
```


# IDENTIFYING DISTRIBUTION
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(fitdistrplus)
measurement = filter(measurements, lambda == 100)
descdist(measurement$response_time, discrete = FALSE, boot=1000)
hist(measurement$response_time, freq = FALSE)
lines(density(measurement$response_time))

measurement = filter(measurements, lambda == 200)
descdist(measurement$response_time, discrete = FALSE, boot=1000)
hist(measurement$response_time, freq = FALSE)
lines(density(measurement$response_time))

simulation = filter(simulations, lambda == 100)
descdist(simulation$response_time, discrete = FALSE, boot=1000)
hist(simulation$response_time, freq = FALSE)
lines(density(simulation$response_time))

simulation = filter(simulations, lambda == 200)
descdist(simulation$response_time, discrete = FALSE, boot=1000)
hist(simulation$response_time, freq = FALSE)
lines(density(simulation$response_time))

descdist(inputs$response_time, discrete = FALSE, boot=1000)
hist(inputs$response_time, freq = FALSE)
lines(density(inputs$response_time))

rm(measurement, simulation)
```


# PLOT CI TABLE
```{r setup, include=FALSE}
require(dplyr)
require(ggplot2)
library(ggpubr)
require(quantileCI)
require(base64enc)
summary_table <- function(df1, tag1, df2, tag2) {
  qCI <- function(df, p) {
    return(quantileCI::quantile_confint_nyblom(df, p))
  }
  stats <- function(df) {
    avg = signif(t.test(df)$conf.int, digits = 2)
    p50 = signif(qCI(df, 0.5), digits = 4)
    p95 = signif(qCI(df, 0.95), digits = 4)
    p99 = signif(qCI(df, 0.99), digits = 4)
    p999 = signif(qCI(df, 0.999), digits = 4)
    p9999 = signif(qCI(df, 0.9999), digits = 4)
    p99999 = signif(qCI(df, 0.99999), digits = 4)
    dist = signif(qCI(df, 0.99999)- qCI(df, 0.5), digits = 4)
    data <- c(avg, p50, p95, p99, p999, p9999, p99999, dist)
    return(data)
  }

  stats1 = stats(df1)
  stats2 = stats(df2)
  avgdf    <- data.frame("avg",    stats1[1],  stats1[2],  stats2[1],  stats2[2])
  p50df    <- data.frame("p50",    stats1[3],  stats1[4],  stats2[3],  stats2[4])
  p95df    <- data.frame("p95",    stats1[5],  stats1[6],  stats2[5],  stats2[6])
  p99df    <- data.frame("p99",    stats1[7],  stats1[8],  stats2[7],  stats2[8])
  p999df   <- data.frame("p999",   stats1[9],  stats1[10], stats2[9],  stats2[10])
  p9999df  <- data.frame("p9999",  stats1[11], stats1[12], stats2[11], stats2[12])
  p99999df <- data.frame("p99999", stats1[13], stats1[14], stats2[13], stats2[14])
  distdf   <- data.frame("dist",   stats1[15], stats1[16], stats2[15], stats2[16])

  tag1_inf = paste(tag1, "cii", sep = ".")
  tag1_sup = paste(tag1, "cis", sep = ".")
  tag2_inf = paste(tag2, "cii", sep = ".")
  tag2_sup = paste(tag2, "cis", sep = ".")
  names(avgdf)    <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p50df)    <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p95df)    <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p99df)    <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p999df)   <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p9999df)  <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(p99999df) <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  names(distdf)   <- c("stats", tag1_inf, tag1_sup, tag2_inf, tag2_sup)
  df <- rbind(avgdf, p50df, p95df, p99df, p999df, p9999df, p99999df, distdf)
  df
}
measurement = filter(measurements, lambda == 100)
simulation = filter(simulations, lambda == 100)
summary_table(measurement$response_time, "measurement", simulation$response_time,"simulation")
summary_table(measurement$response_time, "measurement", inputs$response_time,"inputs")
summary_table(inputs$response_time, "inputs", simulation$response_time,"simulation")

measurement = filter(measurements, lambda == 200)
simulation = filter(simulations, lambda == 200)
summary_table(measurement$response_time, "measurement", simulation$response_time,"simulation")
summary_table(measurement$response_time, "measurement", inputs$response_time,"inputs")
summary_table(inputs$response_time, "inputs", simulation$response_time,"simulation")

rm(measurement, simulation)
```

# STATISTICAL SAMPLE TEST
```{r echo=FALSE, results='hide', message=FALSE, warning=FALSE}
measurement = filter(measurements, lambda == 200)
simulation = filter(simulations, lambda == 200)

ks.test(measurement$response_time, simulation$response_time)
wilcox.test(measurement$response_time, simulation$response_time, alt="two.sided")
require(BWStest)
bws_test(measurement$response_time, simulation$response_time)
t.test(measurement$response_time, simulation$response_time)

rm(measurement, simulation)
```
